name: Build & Deploy Microservices to VPS

on:
  push:
    branches:
      - feature/test_ci_cd
  pull_request:
    branches:
      - feature/test_ci_cd

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

  API_GATEWAY_IMAGE: learnova_api-gateway
  USER_SERVICE_IMAGE: learnova_user-service
  COURSE_SERVICE_IMAGE: learnova_course-service
  SALE_SERVICE_IMAGE: learnova_sale-service
  NOTIFICATION_SERVICE_IMAGE: learnova_notification-service
  SOCKET_SERVER_IMAGE: learnova_socket-server

# =========================
# 1. Detect changed services
# =========================
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.detect.outputs.api-gateway }}
      user-service: ${{ steps.detect.outputs.user-service }}
      course-service: ${{ steps.detect.outputs.course-service }}
      sale-service: ${{ steps.detect.outputs.sale-service }}
      notification-service: ${{ steps.detect.outputs.notification-service }}
      socket-server: ${{ steps.detect.outputs.socket-server }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: detect
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          else
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          fi

          echo "Changed files:"
          echo "$FILES"

          check() {
            echo "$FILES" | grep -q "$1" && echo true || echo false
          }

          echo "api-gateway=$(check rest-api/api-gateway)" >> $GITHUB_OUTPUT
          echo "user-service=$(check rest-api/user-service)" >> $GITHUB_OUTPUT
          echo "course-service=$(check rest-api/course-service)" >> $GITHUB_OUTPUT
          echo "sale-service=$(check rest-api/sale-service)" >> $GITHUB_OUTPUT
          echo "notification-service=$(check rest-api/notification-service)" >> $GITHUB_OUTPUT
          echo "socket-server=$(check socket-server)" >> $GITHUB_OUTPUT

# =========================
# 2. Build & Push Docker
# =========================
  build:
    needs: changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - api-gateway
          - user-service
          - course-service
          - sale-service
          - notification-service
          - socket-server

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push ${{ matrix.service }}
        if: needs.changes.outputs[matrix.service] == 'true'
        uses: docker/build-push-action@v5
        env:
          IMAGE_NAME: ${{ env[format(
            '{0}_IMAGE',
            matrix.service == 'api-gateway' && 'API_GATEWAY' ||
            matrix.service == 'user-service' && 'USER_SERVICE' ||
            matrix.service == 'course-service' && 'COURSE_SERVICE' ||
            matrix.service == 'sale-service' && 'SALE_SERVICE' ||
            matrix.service == 'notification-service' && 'NOTIFICATION_SERVICE' ||
            'SOCKET_SERVER'
          )] }}
          CONTEXT: ${{ matrix.service == 'socket-server' && '.' || './rest-api' }}
          DOCKERFILE: ${{ matrix.service == 'socket-server'
            && 'socket-server/Dockerfile'
            || format('rest-api/{0}/Dockerfile', matrix.service) }}
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Skip ${{ matrix.service }}
        if: needs.changes.outputs[matrix.service] == 'false'
        run: echo "â­ï¸ Skip ${{ matrix.service }}"

# =========================
# 3. Deploy to VPS
# =========================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/feature/test_ci_cd' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_SSH_PORT }} \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            mkdir -p ~/learning-platform/production
            cd ~/learning-platform/production

            echo "ðŸ” Writing env & config files..."

            printf "%s" "${{ secrets.PROD_API_GATEWAY_CONFIG_YAML }}" > api-gateway.application.yaml
            printf "%s" "${{ secrets.PROD_USER_SERVICE_CONFIG_YAML }}" > user-service.application.yaml
            printf "%s" "${{ secrets.PROD_COURSE_SERVICE_CONFIG_YAML }}" > course-service.application.yaml

            printf "%s" "${{ secrets.PROD_SALE_SERVICE_ENV }}" > sale-service.env
            printf "%s" "${{ secrets.PROD_NOTIFICATION_SERVICE_ENV }}" > notification-service.env

            printf "%s" "${{ secrets.AWS_CLOUDFRONT_PRIVATE_KEY_PEM }}" > cloudfront-private-key.pem
            chmod 600 cloudfront-private-key.pem

            printf "%s" "${{ secrets.PROD_DOCKER_COMPOSE_ENV }}" > .env

            echo "ðŸ“¦ Pull latest images..."
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_GATEWAY_IMAGE }}:latest
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.USER_SERVICE_IMAGE }}:latest
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.COURSE_SERVICE_IMAGE }}:latest
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SALE_SERVICE_IMAGE }}:latest
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.NOTIFICATION_SERVICE_IMAGE }}:latest
            docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SOCKET_SERVER_IMAGE }}:latest

            echo "ðŸš€ Deploy done"
            docker compose ps
          EOF

      - run: echo "âœ… Deploy success"
