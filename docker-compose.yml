version: '3.8'

services:
  # ============================================
  # API Gateway (Spring Boot)
  # ============================================
  api-gateway:
    build:
      context: ./rest-api
      dockerfile: api-gateway/Dockerfile
    image: api-gateway:latest
    container_name: learning-platform-api-gateway
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: prod
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    volumes:
      - ./rest-api/api-gateway/src/main/resources/application.yaml:/app/application.yaml
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # User Service (Spring Boot)
  # ============================================
  user-service:
    build:
      context: ./rest-api
      dockerfile: user-service/Dockerfile
    image: user-service:latest
    container_name: learning-platform-user-service
    environment:
      SERVER_PORT: 8081
      SPRING_PROFILES_ACTIVE: prod
    ports:
      - "${USER_SERVICE_PORT:-8081}:8081"
    volumes:
      - ./rest-api/user-service/src/main/resources/application.yaml:/app/application.yaml
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Course Service (Spring Boot)
  # ============================================
  course-service:
    build:
      context: ./rest-api
      dockerfile: course-service/Dockerfile
    image: course-service:latest
    container_name: learning-platform-course-service
    environment:
      SERVER_PORT: 8082
      SPRING_PROFILES_ACTIVE: prod
    ports:
      - "${COURSE_SERVICE_PORT:-8082}:8082"
    volumes:
      - ./rest-api/course-service/src/main/resources/application.yaml:/app/application.yaml
      - ./rest-api/course-service/src/main/resources/cloudfront-private-key.pem:/app/cloudfront-private-key.pem
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Sale Service (Node.js)
  # ============================================
  sale-service:
    build:
      context: ./rest-api
      dockerfile: sale-service/Dockerfile
    image: sale-service:latest
    container_name: learning-platform-sale-service
    environment:
      NODE_ENV: production
      PORT: 3005
    ports:
      - "${SALE_SERVICE_PORT:-3005}:3005"
    volumes:
      - ./rest-api/sale-service/.env:/app/.env
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Notification Service (Node.js)
  # ============================================
  notification-service:
    build:
      context: ./rest-api
      dockerfile: notification-service/Dockerfile
    image: notification-service:latest
    container_name: learning-platform-notification-service
    environment:
      NODE_ENV: production
      PORT: 3002
      GRPC_PORT: 50051
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-3002}:3002"
      - "${NOTIFICATION_GRPC_PORT:-50051}:50051"
    volumes:
      - ./rest-api/notification-service/.env:/app/.env
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Socket Server (Node.js)
  # ============================================
  socket-server:
    build:
      context: .
      dockerfile: socket-server/Dockerfile
    image: socket-server:latest
    container_name: learning-platform-socket-server
    environment:
      NODE_ENV: production
      PORT: 3001
    ports:
      - "${SOCKET_SERVER_PORT:-3001}:3001"
    depends_on:
      - notification-service
    networks:
      - learning-platform-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  learning-platform-network:
    driver: bridge
